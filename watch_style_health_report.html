<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åä¸ºå¥åº·æ•°æ®æŠ¥å‘Šç”Ÿæˆå™¨ - æ‰‹è¡¨å¼</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            padding: 10px;
            color: #333;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 18px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.8em;
            margin-bottom: 6px;
        }

        .header .subtitle {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .main-content {
            padding: 15px;
        }

        /* æ‰‹è¡¨ä¸»ç•Œé¢ */
        .watch-main {
            display: none;
            text-align: center;
            padding: 20px 0;
        }

        .watch-container {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 0 auto 30px;
            background: #1a1a1a;
            border-radius: 50%;
            border: 8px solid #333;
            box-shadow: 
                0 0 30px rgba(0, 0, 0, 0.3),
                inset 0 0 50px rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .watch-container:hover {
            transform: scale(1.02);
        }

        /* è¡¨ç›˜åˆ»åº¦ */
        .watch-face {
            position: relative;
            width: 260px;
            height: 260px;
            background: radial-gradient(circle, #2a2a2a, #1a1a1a);
            border-radius: 50%;
            border: 2px solid #555;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .watch-scale {
            position: absolute;
            width: 240px;
            height: 240px;
        }

        .scale-mark {
            position: absolute;
            width: 2px;
            height: 15px;
            background: #888;
            top: 10px;
            left: 50%;
            transform-origin: center 110px;
        }

        .scale-mark.major {
            width: 3px;
            height: 25px;
            background: #fff;
        }

        /* æ•°å­—æ˜¾ç¤º */
        .watch-time {
            position: absolute;
            top: 60px;
            color: #fff;
            font-size: 1.8em;
            font-weight: 300;
            font-family: 'Arial', sans-serif;
            text-align: center;
            width: 100%;
        }

        .watch-date {
            position: absolute;
            top: 90px;
            color: #ccc;
            font-size: 0.8em;
            text-align: center;
            width: 100%;
        }

        .watch-moon {
            position: absolute;
            bottom: 80px;
            color: #f0f0f0;
            font-size: 0.9em;
            text-align: center;
            width: 100%;
        }

        .center-button {
            position: relative;
            width: 70px;
            height: 70px;
            background: radial-gradient(circle, #4a90e2, #357abd);
            border-radius: 50%;
            border: 3px solid #555;
            color: white;
            font-size: 0.7em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 
                0 2px 8px rgba(74, 144, 226, 0.3),
                inset 0 1px 2px rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            line-height: 1.1;
            z-index: 10;
        }

        .center-button:hover {
            background: radial-gradient(circle, #5ba0f2, #4580cd);
            box-shadow: 
                0 4px 12px rgba(74, 144, 226, 0.4),
                inset 0 1px 2px rgba(255, 255, 255, 0.3);
        }

        .center-button:active {
            transform: scale(0.95);
            background: radial-gradient(circle, #3a80d2, #2a60ad);
        }

        .module-button {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid #444;
            color: white;
            font-size: 0.6em;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            line-height: 1.1;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            z-index: 5;
        }

        /* ç§»é™¤æ‰€æœ‰åŠ¨æ€æ•ˆæœ - é™æ€æŒ‰é’® */

        .module-sleep {
            top: -5px;
            left: 50%;
            transform: translateX(-50%);
            background: #3498db;
        }

        .module-activity {
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            background: #27ae60;
        }

        .module-cycle {
            right: -5px;
            top: 50%;
            transform: translateY(-50%);
            background: #9b59b6;
        }

        .module-report {
            left: -5px;
            top: 50%;
            transform: translateY(-50%);
            background: #e74c3c;
        }

        .module-icon {
            font-size: 1.2em;
            margin-bottom: 2px;
        }

        /* æ•°æ®å½•å…¥ç•Œé¢ */
        .data-entry {
            display: none;
        }

        .section {
            margin-bottom: 15px;
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 1px 6px rgba(0, 0, 0, 0.08);
        }

        .section-title {
            font-size: 1.1em;
            color: #2c3e50;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .back-button {
            background: #6c757d;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            cursor: pointer;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        /* æ—‹é’®ç»„ä»¶æ ·å¼ */
        .knob-container {
            background: white;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .knob-container:hover {
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        }

        .knob-label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.85em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .knob-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .knob-input {
            width: 60px;
            padding: 4px 6px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 0.8em;
            text-align: center;
            transition: border-color 0.3s;
        }

        .knob-input:focus {
            outline: none;
            border-color: #4facfe;
        }

        .knob-unit-small {
            font-size: 0.75em;
            color: #6c757d;
            white-space: nowrap;
        }

        .knob-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .knob-controls {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 6px;
        }

        .knob-btn {
            background: #4facfe;
            color: white;
            border: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .knob-btn:hover {
            background: #3d8bfe;
            transform: scale(1.1);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .knob-btn:active {
            transform: scale(0.95);
        }

        .knob {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: conic-gradient(from 0deg, #e1e8ed 0deg, #4facfe var(--rotation, 0deg), #e1e8ed var(--rotation, 0deg));
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .knob:hover {
            transform: scale(1.05);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
        }

        .knob::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 2;
        }

        .knob::after {
            content: '';
            position: absolute;
            top: 4px;
            left: 50%;
            width: 2px;
            height: 18px;
            background: #4facfe;
            transform: translateX(-50%) rotate(calc(var(--rotation, 0deg) - 90deg));
            transform-origin: center 26px;
            border-radius: 1px;
        }

        .knob-value {
            font-size: 1em;
            font-weight: bold;
            color: #2c3e50;
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 6px;
            min-width: 50px;
            text-align: center;
            border: 1px solid #e9ecef;
        }

        .knob-unit {
            font-size: 0.7em;
            color: #6c757d;
        }

        /* Emojié€‰æ‹©å™¨æ ·å¼ */
        .emoji-container {
            background: white;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
        }

        .emoji-label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.9em;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .emoji-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .emoji-option {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .emoji-option:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }

        .emoji-option.selected {
            border-color: #4facfe;
            background: #e3f2fd;
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(79, 172, 254, 0.3);
        }

        .emoji-icon {
            font-size: 1.8em;
        }

        .emoji-text {
            font-size: 0.8em;
            color: #495057;
        }

        /* æŒ‰é’®æ ·å¼ */
        .add-day-btn, .generate-btn {
            background: #34495e;
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 6px;
            font-size: 0.8em;
            cursor: pointer;
            margin: 10px 8px;
            display: inline-block;
            transition: all 0.2s ease;
        }

        .add-day-btn:hover {
            background: #2c3e50;
            box-shadow: 0 2px 8px rgba(52, 73, 94, 0.3);
        }

        .generate-btn {
            background: #3498db;
            font-size: 0.85em;
            padding: 12px 24px;
        }

        .generate-btn:hover {
            background: #2980b9;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
        }

        .generate-btn.success {
            background: #27ae60;
        }



        /* æŠ¥å‘Šè¾“å‡ºåŒºåŸŸ */
        .report-output {
            background: linear-gradient(135deg, #f8f9fa, #ffffff);
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 15px;
            min-height: 120px;
            margin-top: 15px;
            white-space: pre-wrap;
            font-family: 'Microsoft YaHei', 'PingFang SC', sans-serif;
            line-height: 1.4;
            color: #495057;
            font-size: 0.85em;
        }

        .button-group {
            text-align: center;
            margin-top: 15px;
        }

        /* éšè—çš„inputç”¨äºå­˜å‚¨å€¼ */
        .hidden-input {
            display: none;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
            
            .container {
                margin: 2px;
            }
            
            .main-content {
                padding: 10px;
            }
            
            .watch-container {
                width: 250px;
                height: 250px;
            }
            
            .watch-face {
                width: 210px;
                height: 210px;
            }
            
            .watch-scale {
                width: 190px;
                height: 190px;
            }
            
            .scale-mark {
                top: 8px;
                transform-origin: center 87px;
            }
            
            .scale-mark.major {
                height: 20px;
            }
            
            .scale-mark {
                height: 12px;
            }
            
            .center-button {
                width: 55px;
                height: 55px;
                font-size: 0.6em;
            }
            
            .module-button {
                width: 45px;
                height: 45px;
                font-size: 0.55em;
            }
            
            .watch-time {
                font-size: 1.4em;
                top: 50px;
            }
            
            .watch-date {
                font-size: 0.7em;
                top: 75px;
            }
            
            .watch-moon {
                font-size: 0.8em;
                bottom: 60px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .knob-input-group {
                flex-direction: column;
                gap: 8px;
            }
            
            .emoji-options {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }
            
            .emoji-option {
                padding: 8px;
            }
            
            #watchReportArea {
                margin: 15px 5px 0 5px;
                padding: 12px;
                font-size: 0.8em;
                max-height: 300px;
                overflow-y: auto;
            }
            
            #watchReportArea button {
                padding: 3px 6px;
                font-size: 0.65em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>åä¸ºå¥åº·æ•°æ®æŠ¥å‘Š</h1>
            <div class="subtitle" id="dataPeriod">æ•°æ®å‘¨æœŸï¼šåŠ è½½ä¸­...</div>
        </div>

        <div class="main-content">
            <!-- æ‰‹è¡¨ä¸»ç•Œé¢ -->
            <div class="watch-main" id="watchMain">
                <h2 style="margin-bottom: 20px; color: #2c3e50;">æ™ºèƒ½å¥åº·æ‰‹è¡¨</h2>
                <div class="watch-container" onclick="showWatchMain()">
                    <div class="watch-face">
                        <div class="watch-scale" id="watchScale">
                            <!-- è¡¨ç›˜åˆ»åº¦å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                        </div>
                        <div class="watch-time" id="watchTime">
                            --:--
                        </div>
                        <div class="watch-date" id="watchDate">
                            11æœˆ27æ—¥ å‘¨ä¸‰
                        </div>
                        <div class="watch-moon" id="watchMoon">
                            ğŸŒ‘ æ–°æœˆ
                        </div>
                        

                        
                        <button class="module-button module-sleep" onclick="event.stopPropagation(); openModule('sleep')">
                            <div class="module-icon">ğŸ˜´</div>
                            <div>ç¡çœ </div>
                        </button>
                        
                        <button class="module-button module-activity" onclick="event.stopPropagation(); openModule('activity')">
                            <div class="module-icon">ğŸƒâ€â™€ï¸</div>
                            <div>è¿åŠ¨</div>
                        </button>
                        
                        <button class="module-button module-cycle" onclick="event.stopPropagation(); openModule('cycle')">
                            <div class="module-icon">ğŸŒ™</div>
                            <div>å‘¨æœŸ</div>
                        </button>
                        
                        <button class="module-button module-report" onclick="event.stopPropagation(); generateAndCopyReportFromWatch()">
                            <div class="module-icon">ğŸ“Š</div>
                            <div>æŠ¥å‘Š</div>
                        </button>
                    </div>
                </div>
                <p style="color: #6c757d; font-size: 0.9em; margin-top: 15px;">ç‚¹å‡»è¡¨ç›˜å¤–åŒºåŸŸæˆ–æŒ‰é’®è¿”å›ä¸»ç•Œé¢</p>
                
                <!-- æŠ¥å‘Šæ˜¾ç¤ºåŒºåŸŸ -->
                <div id="watchReportArea" style="display: none; margin-top: 20px; background: linear-gradient(135deg, #f8f9fa, #ffffff); border: 2px dashed #dee2e6; border-radius: 12px; padding: 15px; min-height: 120px; white-space: pre-wrap; font-family: 'Microsoft YaHei', 'PingFang SC', sans-serif; line-height: 1.5; color: #495057; font-size: 0.85em; position: relative;">
                    <div style="position: absolute; top: 8px; right: 8px;">
                        <button onclick="hideWatchReport()" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.7em; cursor: pointer;">âœ• å…³é—­</button>
                    </div>
                    <div id="watchReportContent">è¯·å½•å…¥å¥åº·æ•°æ®åç‚¹å‡»æŠ¥å‘ŠæŒ‰é’®æŸ¥çœ‹æ±‡æ€»</div>
                </div>
            </div>

            <!-- æ•°æ®å½•å…¥ç•Œé¢ -->
            <div class="data-entry" id="dataEntry">
                <button class="back-button" onclick="showWatchMain()" style="display: inline-flex; align-items: center; gap: 8px;">
                    <span style="font-size: 1.2em;">âŒš</span>
                    è¿”å›ä¸»ç•Œé¢
                </button>
                <div class="section">
                    <h2 class="section-title" id="moduleTitle">æ¨¡å—æ•°æ®å½•å…¥</h2>
                    
                    <form id="healthDataForm">
                        <div id="daysContainer">
                            <!-- å¤©æ•°è¡¨å•å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                        
                        <div class="button-group">
                            <button type="button" class="add-day-btn" onclick="addDay()">+ æ·»åŠ å¤©æ•°</button>
                            <button type="button" class="generate-btn" onclick="generateAndCopyReport()">ç”Ÿæˆå¹¶å¤åˆ¶æŠ¥å‘Š</button>
                        </div>
                        
                        <!-- åŠŸèƒ½æŒ‰é’®ç»„ -->
                        <div class="button-group">
                            <button type="button" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 0.7em; cursor: pointer; margin: 5px;" onclick="resetAllData()">é‡ç½®æ•°æ®</button>
                            <button type="button" style="background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 0.7em; cursor: pointer; margin: 5px;" onclick="checkAndReturnToMain()">å·²å½•å…¥ï¼Œå¯è¿”å›</button>
                            <button type="button" style="background: #17a2b8; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 0.7em; cursor: pointer; margin: 5px;" onclick="console.log('å½“å‰å…¨å±€æ•°æ®:', globalHealthData)">æŸ¥çœ‹å­˜å‚¨æ•°æ®</button>
                        </div>
                    </form>
                </div>

                <!-- æŠ¥å‘Šè¾“å‡ºåŒºåŸŸ -->
                <div class="section">
                    <h2 class="section-title">å¥åº·æŠ¥å‘Š</h2>
                    <div id="reportOutput" class="report-output">
è¯·åœ¨ä¸Šæ–¹è¡¨å•ä¸­è¾“å…¥å¥åº·æ•°æ®ï¼Œç„¶åç‚¹å‡»"ç”Ÿæˆå¹¶å¤åˆ¶æŠ¥å‘Š"æŒ‰é’®è·å–æ±‡æ€»æŠ¥å‘Šã€‚
                    </div>
                </div>
            </div>

            <div style="background: #fff3cd; padding: 12px; border-radius: 8px; border-left: 3px solid #ffc107; font-size: 0.8em; color: #856404; margin-top: 15px;">
                <strong>è®¾å¤‡ä¿¡æ¯ï¼š</strong> HUAWEI WATCH 4 | æ•°æ®æ¥æºï¼šåä¸ºè¿åŠ¨å¥åº·App
            </div>
        </div>
    </div>

    <script>
        let currentModule = '';
        let dayCount = 1; // é»˜è®¤1å¤©
        
        // å…¨å±€æ•°æ®å­˜å‚¨ï¼šä¿å­˜æ‰€æœ‰æ¨¡å—çš„å½•å…¥æ•°æ®
        let globalHealthData = {};

        // æ—‹é’®é…ç½®
        const knobConfigs = {
            deepSleep: { min: 0, max: 10, step: 0.5, unit: 'å°æ—¶', default: 6.0 },
            sleepScore: { min: 0, max: 100, step: 1, unit: 'åˆ†', default: 82 },
            stressLevel: { min: 0, max: 100, step: 1, unit: '', default: 65 },
            dailySteps: { min: 0, max: 20000, step: 100, unit: 'æ­¥', default: 7500 },
            restingHR: { min: 40, max: 120, step: 1, unit: 'æ¬¡/åˆ†', default: 68 },
            bloodOxygen: { min: 80, max: 100, step: 1, unit: '%', default: 97 }
        };

        // Emojié€‰é¡¹é…ç½®
        const emojiConfigs = {
            cycleStatus: [
                { value: 'å®‰å…¨æœŸ', emoji: 'ğŸ›¡ï¸', text: 'å®‰å…¨æœŸ' },
                { value: 'æ’åµæœŸ', emoji: 'ğŸŒŸ', text: 'æ’åµæœŸ' },
                { value: 'ç»æœŸ', emoji: 'ğŸŒ¸', text: 'ç»æœŸ' }
            ],
            moodStatus: [
                { value: 'æ™®é€š', emoji: 'ğŸ˜', text: 'æ™®é€š' },
                { value: 'ç–²æƒ«', emoji: 'ğŸ˜´', text: 'ç–²æƒ«' },
                { value: 'æ˜“æ€’', emoji: 'ğŸ˜¤', text: 'æ˜“æ€’' }
            ]
        };

        // æ¨¡å—é…ç½®
        const moduleConfigs = {
            sleep: {
                title: 'ç¡çœ å¥åº·æ•°æ®å½•å…¥',
                fields: ['deepSleep', 'restingHR', 'bloodOxygen'],
                description: 'åŒ…å«ç¡çœ æ—¶é•¿ã€é™æ¯å¿ƒç‡ã€è¡€æ°§é¥±å’Œåº¦'
            },
            activity: {
                title: 'è¿åŠ¨æ´»åŠ›æ•°æ®å½•å…¥', 
                fields: ['stressLevel', 'dailySteps', 'moodStatus'],
                description: 'åŒ…å«å‹åŠ›å€¼ã€æ­¥æ•°ã€å¿ƒæƒ…çŠ¶æ€'
            },
            cycle: {
                title: 'ç”Ÿç†å‘¨æœŸæ•°æ®å½•å…¥',
                fields: ['cycleStatus'],
                description: 'ç”Ÿç†å‘¨æœŸçŠ¶æ€è·Ÿè¸ª'
            }
        };

        function showWatchMain() {
            document.getElementById('watchMain').style.display = 'block';
            document.getElementById('dataEntry').style.display = 'none';
            document.getElementById('watchReportArea').style.display = 'none';
            currentModule = '';
        }

        function openModule(moduleType) {
            currentModule = moduleType;
            const config = moduleConfigs[moduleType];
            
            document.getElementById('watchMain').style.display = 'none';
            document.getElementById('dataEntry').style.display = 'block';
            document.getElementById('watchReportArea').style.display = 'none';
            document.getElementById('moduleTitle').innerHTML = `
                ${config.title}
                <span style="font-size: 0.8em; color: #6c757d; font-weight: normal;">- ${config.description}</span>
            `;
            
            // åˆå§‹åŒ–æ•°æ®
            initializeForm();
        }

        function initializeForm() {
            const container = document.getElementById('daysContainer');
            container.innerHTML = '';
            dayCount = 1;
            
            for (let i = 1; i <= dayCount; i++) {
                const daySection = createDaySection(i);
                container.appendChild(daySection);
            }
            
            // åˆå§‹åŒ–å®Œæˆåæ¢å¤å½“å‰æ¨¡å—çš„å·²ä¿å­˜æ•°æ®
            setTimeout(() => {
                restoreCurrentModuleData();
            }, 100);
        }

        function createKnob(fieldName, config, dayNumber, value) {
            const percentage = ((value - config.min) / (config.max - config.min)) * 270;
            
            return `
                <div class="knob-container">
                    <div class="knob-label">
                        <span>ğŸ“Š</span>
                        <span>${getFieldLabel(fieldName)}</span>
                    </div>
                    <div class="knob-input-group">
                        <div class="knob-wrapper">
                            <div class="knob-controls">
                                <button type="button" class="knob-btn" onclick="adjustKnob('${fieldName}', ${dayNumber}, ${config.step}, 'decrease')">âˆ’</button>
                                <button type="button" class="knob-btn" onclick="adjustKnob('${fieldName}', ${dayNumber}, ${config.step}, 'increase')">+</button>
                            </div>
                            <div class="knob" 
                                 onclick="adjustKnob('${fieldName}', ${dayNumber}, ${config.step}, 'increase')" 
                                 style="--rotation: ${percentage}deg"
                                 id="knob-${fieldName}-${dayNumber}">
                            </div>
                            <div class="knob-value">
                                <span id="value-${fieldName}-${dayNumber}">${value}</span>
                                <span class="knob-unit">${config.unit}</span>
                            </div>
                        </div>
                        <div class="direct-input">
                            <input type="number" 
                                   class="knob-input" 
                                   id="direct-${fieldName}-${dayNumber}"
                                   placeholder="ç›´æ¥è¾“å…¥"
                                   min="${config.min}"
                                   max="${config.max}"
                                   step="${config.step}"
                                   oninput="updateFromDirectInput('${fieldName}', ${dayNumber}, '${config.unit}')">
                            <span class="knob-unit-small">${config.unit}</span>
                        </div>
                        <input type="hidden" name="${fieldName}_${dayNumber}" id="input-${fieldName}-${dayNumber}" value="${value}">
                    </div>
                </div>
            `;
        }

        // ä¿å­˜å½“å‰æ¨¡å—æ•°æ®çš„å‡½æ•°
        function saveCurrentModuleData() {
            if (!currentModule) return;
            
            // ç¡®ä¿å…¨å±€æ•°æ®å¯¹è±¡ç»“æ„æ­£ç¡®
            if (!globalHealthData[currentModule]) {
                globalHealthData[currentModule] = {};
            }
            
            const config = moduleConfigs[currentModule];
            
            // è·å–å½“å‰é¡µé¢ä¸­çš„æ‰€æœ‰å¤©æ•°
            const daySections = document.querySelectorAll('.day-section');
            const currentDayCount = daySections.length;
            
            // ä¸ºæ¯ä¸€å¤©ä¿å­˜æ•°æ®
            for (let day = 1; day <= currentDayCount; day++) {
                const dayData = { day: day, module: currentModule };
                
                config.fields.forEach(fieldName => {
                    if (knobConfigs[fieldName]) {
                        // ä¿å­˜æ•°å€¼å­—æ®µ
                        const input = document.getElementById(`input-${fieldName}-${day}`);
                        if (input && input.value && !isNaN(parseFloat(input.value))) {
                            dayData[fieldName] = parseFloat(input.value);
                        }
                    } else if (emojiConfigs[fieldName]) {
                        // ä¿å­˜é€‰æ‹©å­—æ®µ
                        const selectedOption = document.querySelector(`input[name="${fieldName}_${day}"]`);
                        if (selectedOption && selectedOption.value) {
                            dayData[fieldName] = selectedOption.value;
                        }
                    }
                });
                
                // ä¿å­˜åˆ°å…¨å±€å­˜å‚¨
                if (Object.keys(dayData).length > 2) { // è¶…è¿‡day, moduleä¸¤ä¸ªå­—æ®µæ‰ç®—æœ‰æ•ˆæ•°æ®
                    globalHealthData[currentModule][day] = dayData;
                } else {
                    // å¦‚æœæ²¡æœ‰æœ‰æ•ˆæ•°æ®ï¼Œåˆ é™¤è¯¥å¤©çš„è®°å½•
                    delete globalHealthData[currentModule][day];
                }
            }
            
            console.log(`å·²ä¿å­˜ ${currentModule} æ¨¡å—æ•°æ®:`, globalHealthData[currentModule]);
        }

        // ä»å…¨å±€å­˜å‚¨æ¢å¤å½“å‰æ¨¡å—æ•°æ®çš„å‡½æ•°
        function restoreCurrentModuleData() {
            if (!currentModule) return;
            
            const savedModuleData = globalHealthData[currentModule];
            if (!savedModuleData || Object.keys(savedModuleData).length === 0) return;
            
            const config = moduleConfigs[currentModule];
            
            // è·å–ä¿å­˜æ•°æ®çš„å¤©æ•°
            const savedDays = Object.keys(savedModuleData).map(day => parseInt(day)).filter(day => !isNaN(day));
            if (savedDays.length === 0) return;
            
            // ç¡®å®šéœ€è¦æ¢å¤çš„å¤©æ•°ï¼ˆå¯èƒ½æ¯”å½“å‰é¡µé¢æ˜¾ç¤ºçš„è¦å¤šï¼‰
            const maxDay = Math.max(...savedDays);
            
            // å¦‚æœä¿å­˜çš„å¤©æ•°æ¯”å½“å‰æ˜¾ç¤ºçš„å¤šï¼Œéœ€è¦æ·»åŠ å¤©æ•°
            const currentDays = document.querySelectorAll('.day-section').length;
            if (maxDay > currentDays) {
                for (let day = currentDays + 1; day <= maxDay; day++) {
                    addDay();
                }
            }
            
            // æ¢å¤æ¯ä¸€å¤©çš„æ•°æ®
            savedDays.forEach(day => {
                const dayData = savedModuleData[day];
                if (!dayData) return;
                
                config.fields.forEach(fieldName => {
                    if (dayData[fieldName] !== undefined) {
                        if (knobConfigs[fieldName]) {
                            // æ¢å¤æ•°å€¼å­—æ®µ
                            const input = document.getElementById(`input-${fieldName}-${day}`);
                            const directInput = document.getElementById(`direct-${fieldName}-${day}`);
                            const valueDisplay = document.getElementById(`value-${fieldName}-${day}`);
                            const knob = document.getElementById(`knob-${fieldName}-${day}`);
                            
                            if (input && knob && knobConfigs[fieldName]) {
                                const value = dayData[fieldName];
                                const knobConfig = knobConfigs[fieldName];
                                
                                input.value = value;
                                if (directInput) directInput.value = value;
                                if (valueDisplay) valueDisplay.textContent = fieldName.includes('Steps') ? Math.round(value) : value;
                                
                                // æ›´æ–°æ—‹é’®è§’åº¦
                                const percentage = ((value - knobConfig.min) / (knobConfig.max - knobConfig.min)) * 270;
                                knob.style.setProperty('--rotation', percentage + 'deg');
                            }
                        } else if (emojiConfigs[fieldName]) {
                            // æ¢å¤é€‰æ‹©å­—æ®µ
                            const option = document.querySelector(`input[name="${fieldName}_${day}"][value="${dayData[fieldName]}"]`);
                            if (option) {
                                selectEmoji(fieldName, day, dayData[fieldName], option.closest('.emoji-option'));
                            }
                        }
                    }
                });
            });
            
            
            console.log(`å·²æ¢å¤ ${currentModule} æ¨¡å—æ•°æ®:`, savedModuleData);
        }

        function createEmojiSelector(fieldName, config, dayNumber, defaultValue) {
            return `
                <div class="emoji-container">
                    <div class="emoji-label">
                        <span>${getEmojiLabel(fieldName)}</span>
                        <span>${getFieldLabel(fieldName)}</span>
                    </div>
                    <div class="emoji-options">
                        ${config.map(option => `
                            <div class="emoji-option ${option.value === defaultValue ? 'selected' : ''}" 
                                 onclick="selectEmoji('${fieldName}', ${dayNumber}, '${option.value}', this)">
                                <div class="emoji-icon">${option.emoji}</div>
                                <div class="emoji-text">${option.text}</div>
                                <input type="hidden" name="${fieldName}_${dayNumber}" value="${option.value}">
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function getFieldLabel(fieldName) {
            const labels = {
                deepSleep: 'ç¡çœ æ—¶é•¿',
                sleepScore: 'ç¡çœ å¾—åˆ†',
                stressLevel: 'å‹åŠ›å€¼',
                dailySteps: 'æ­¥æ•°',
                restingHR: 'é™æ¯å¿ƒç‡',
                bloodOxygen: 'è¡€æ°§é¥±å’Œåº¦',
                cycleStatus: 'ç”Ÿç†å‘¨æœŸçŠ¶æ€',
                moodStatus: 'ä¸»è§‚æ„Ÿå—'
            };
            return labels[fieldName] || fieldName;
        }

        function getEmojiLabel(fieldName) {
            const emojis = {
                cycleStatus: 'ğŸŒ™',
                moodStatus: 'ğŸ˜Š'
            };
            return emojis[fieldName] || 'ğŸ“';
        }

        function adjustKnob(fieldName, dayNumber, step, direction) {
            const input = document.getElementById(`input-${fieldName}-${dayNumber}`);
            const valueDisplay = document.getElementById(`value-${fieldName}-${dayNumber}`);
            const knob = document.getElementById(`knob-${fieldName}-${dayNumber}`);
            
            if (!input || !valueDisplay || !knob) return;
            
            const config = knobConfigs[fieldName];
            let currentValue = parseFloat(input.value);
            let newValue;
            
            if (direction === 'decrease') {
                newValue = currentValue - step;
            } else {
                newValue = currentValue + step;
            }
            
            // å¾ªç¯æ»šåŠ¨
            if (newValue > config.max) newValue = config.min;
            if (newValue < config.min) newValue = config.max;
            
            input.value = newValue;
            valueDisplay.textContent = fieldName.includes('Steps') ? Math.round(newValue) : newValue;
            
            // æ¸…é™¤ç›´æ¥è¾“å…¥æ¡†
            const directInput = document.getElementById(`direct-${fieldName}-${dayNumber}`);
            if (directInput) directInput.value = '';
            
            // æ›´æ–°æ—‹é’®è§’åº¦
            const percentage = ((newValue - config.min) / (config.max - config.min)) * 270;
            knob.style.setProperty('--rotation', percentage + 'deg');
            
            // è‡ªåŠ¨ä¿å­˜æ•°æ®åˆ°å…¨å±€å­˜å‚¨
            saveCurrentModuleData();
        }

        function updateFromDirectInput(fieldName, dayNumber, unit) {
            const directInput = document.getElementById(`direct-${fieldName}-${dayNumber}`);
            const input = document.getElementById(`input-${fieldName}-${dayNumber}`);
            const valueDisplay = document.getElementById(`value-${fieldName}-${dayNumber}`);
            const knob = document.getElementById(`knob-${fieldName}-${dayNumber}`);
            
            if (!directInput || !input || !valueDisplay || !knob) return;
            
            const config = knobConfigs[fieldName];
            const newValue = parseFloat(directInput.value);
            
            // éªŒè¯è¾“å…¥å€¼æ˜¯å¦åœ¨èŒƒå›´å†…
            if (isNaN(newValue) || newValue < config.min || newValue > config.max) {
                return; // ä¸æ›´æ–°ï¼Œä¿æŒå½“å‰çŠ¶æ€
            }
            
            // æ›´æ–°æ‰€æœ‰ç›¸å…³å€¼
            input.value = newValue;
            valueDisplay.textContent = fieldName.includes('Steps') ? Math.round(newValue) : newValue;
            
            // æ›´æ–°æ—‹é’®è§’åº¦
            const percentage = ((newValue - config.min) / (config.max - config.min)) * 270;
            knob.style.setProperty('--rotation', percentage + 'deg');
            
            // è‡ªåŠ¨ä¿å­˜æ•°æ®åˆ°å…¨å±€å­˜å‚¨
            saveCurrentModuleData();
        }

        function selectEmoji(fieldName, dayNumber, value, element) {
            // ç§»é™¤åŒä¸€ç»„ä¸­å…¶ä»–é€‰é¡¹çš„é€‰ä¸­çŠ¶æ€
            const siblings = element.parentElement.children;
            for (let sibling of siblings) {
                sibling.classList.remove('selected');
            }
            
            // æ·»åŠ å½“å‰é€‰é¡¹çš„é€‰ä¸­çŠ¶æ€
            element.classList.add('selected');
            
            // æ›´æ–°éšè—inputçš„å€¼
            const hiddenInput = element.querySelector('input[type="hidden"]');
            if (hiddenInput) {
                hiddenInput.value = value;
            }
            
            // è‡ªåŠ¨ä¿å­˜æ•°æ®åˆ°å…¨å±€å­˜å‚¨
            saveCurrentModuleData();
        }

        function createDaySection(dayNumber) {
            const daySection = document.createElement('div');
            daySection.className = 'day-section';
            daySection.id = `day-${dayNumber}`;
            daySection.style.cssText = `
                border: 2px solid #e9ecef;
                border-radius: 10px;
                padding: 15px;
                margin-bottom: 15px;
                position: relative;
                background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
                transition: all 0.3s ease;
            `;
            
            daySection.onmouseenter = function() {
                this.style.borderColor = '#4facfe';
                this.style.boxShadow = '0 2px 8px rgba(79, 172, 254, 0.1)';
            };
            daySection.onmouseleave = function() {
                this.style.borderColor = '#e9ecef';
                this.style.boxShadow = 'none';
            };
            
            const dayHeader = document.createElement('div');
            dayHeader.style.cssText = `
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 15px;
            `;
            
            const dayTitle = document.createElement('div');
            dayTitle.style.cssText = `
                font-weight: 600;
                color: #495057;
                font-size: 1em;
                display: flex;
                align-items: center;
                gap: 8px;
            `;
            dayTitle.innerHTML = `
                <span style="background: linear-gradient(135deg, #4facfe, #00f2fe); color: white; padding: 4px 10px; border-radius: 15px; font-size: 0.8em;">ç¬¬${dayNumber}å¤©</span>
                <span>ğŸ“…</span>
            `;
            
            dayHeader.appendChild(dayTitle);
            
            if (dayNumber > 1) {
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.textContent = 'åˆ é™¤';
                removeBtn.style.cssText = `
                    background: #dc3545;
                    color: white;
                    border: none;
                    padding: 6px 12px;
                    border-radius: 10px;
                    font-size: 0.7em;
                    cursor: pointer;
                    transition: all 0.3s ease;
                `;
                removeBtn.onmouseenter = function() {
                    this.style.background = '#c82333';
                    this.style.transform = 'translateY(-1px)';
                };
                removeBtn.onmouseleave = function() {
                    this.style.background = '#dc3545';
                    this.style.transform = 'translateY(0)';
                };
                removeBtn.onclick = () => removeDay(dayNumber);
                dayHeader.appendChild(removeBtn);
            }
            
            daySection.appendChild(dayHeader);
            
            // åˆ›å»ºè¡¨å•ç½‘æ ¼
            const formGrid = document.createElement('div');
            formGrid.className = 'form-grid';
            
            const config = moduleConfigs[currentModule];
            const defaults = {
                1: { deepSleep: 6.0, restingHR: 68, bloodOxygen: 97, stressLevel: 65, dailySteps: 7500, moodStatus: 'æ™®é€š', cycleStatus: 'å®‰å…¨æœŸ' }
            };
            
            const dayDefaults = defaults[dayNumber] || defaults[1];
            
            // æ ¹æ®æ¨¡å—ç±»å‹åˆ›å»ºå­—æ®µ
            config.fields.forEach(fieldName => {
                if (knobConfigs[fieldName]) {
                    const value = dayDefaults[fieldName] || knobConfigs[fieldName].default;
                    formGrid.innerHTML += createKnob(fieldName, knobConfigs[fieldName], dayNumber, value);
                } else if (emojiConfigs[fieldName]) {
                    const value = dayDefaults[fieldName] || emojiConfigs[fieldName][0].value;
                    formGrid.innerHTML += createEmojiSelector(fieldName, emojiConfigs[fieldName], dayNumber, value);
                }
            });
            
            daySection.appendChild(formGrid);
            
            return daySection;
        }

        function addDay() {
            if (dayCount >= 7) {
                alert('æœ€å¤šåªèƒ½å½•å…¥7å¤©æ•°æ®');
                return;
            }
            
            dayCount++;
            const daySection = createDaySection(dayCount);
            const container = document.getElementById('daysContainer');
            container.appendChild(daySection);
        }

        function removeDay(dayNumber) {
            if (dayCount <= 1) {
                alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€å¤©æ•°æ®');
                return;
            }
            
            const daySection = document.getElementById(`day-${dayNumber}`);
            if (daySection) {
                daySection.remove();
                dayCount--;
            }
        }

        function generateAndCopyReport() {
            // ä»æ•°æ®å½•å…¥ç•Œé¢ç”ŸæˆæŠ¥å‘Š
            let allData = [];
            
            if (currentModule) {
                // ä»å…·ä½“æ¨¡å—æ”¶é›†æ•°æ®
                allData = collectModuleData();
            } else {
                // å¦‚æœæ²¡æœ‰é€‰æ‹©æ¨¡å—ï¼Œå°è¯•ä»å½“å‰å¯è§çš„è¡¨å•æ”¶é›†æ•°æ®
                const daysContainer = document.getElementById('daysContainer');
                const daySections = daysContainer.querySelectorAll('.day-section');
                
                if (daySections.length === 0) {
                    alert('è¯·å…ˆé€‰æ‹©å¥åº·æ¨¡å—å¹¶å½•å…¥æ•°æ®');
                    return;
                }
                
                // æ”¶é›†å½“å‰æ¨¡å—çš„æ•°æ®
                allData = collectModuleData();
            }
            
            if (allData.length === 0) {
                alert('è¯·è‡³å°‘å½•å…¥ä¸€å¤©çš„å¥åº·æ•°æ®');
                return;
            }
            
            // ç¡®ä¿åœ¨æ•°æ®å½•å…¥ç•Œé¢
            if (document.getElementById('dataEntry').style.display !== 'block') {
                openModule('sleep'); // é»˜è®¤æ‰“å¼€ä¸€ä¸ªæ¨¡å—ç•Œé¢
            }
            
            // ç”ŸæˆæŠ¥å‘Šå¹¶æ˜¾ç¤ºåœ¨æŠ¥å‘Šè¾“å‡ºåŒºåŸŸ
            const report = generateHealthReport(allData);
            document.getElementById('reportOutput').textContent = report;
            
            // å¤åˆ¶åˆ°å‰ªè´´æ¿
            copyReport(report);
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            showCopySuccess();
        }

        function generateAndCopyReportFromWatch() {
            // ä»æ‰‹è¡¨ä¸»ç•Œé¢ç”ŸæˆæŠ¥å‘Šï¼ŒåªåŒ…å«å®é™…å½•å…¥çš„æ•°æ®
            const allData = collectActualEnteredData();
            
            if (allData.length === 0) {
                // æ˜¾ç¤ºæç¤ºä¿¡æ¯
                showWatchReport('è¯·å…ˆåœ¨ç¡çœ ã€è¿åŠ¨ã€å‘¨æœŸæ¨¡å—ä¸­å½•å…¥å¥åº·æ•°æ®ï¼Œç„¶åå†æ¬¡ç‚¹å‡»æŠ¥å‘ŠæŒ‰é’®ã€‚\n\næç¤ºï¼š\nâ€¢ ç‚¹å‡»ğŸ˜´ç¡çœ å½•å…¥ç¡çœ æ—¶é•¿ã€é™æ¯å¿ƒç‡ã€è¡€æ°§æ•°æ®\nâ€¢ ç‚¹å‡»ğŸƒâ€â™€ï¸è¿åŠ¨å½•å…¥å‹åŠ›å€¼ã€æ­¥æ•°ã€å¿ƒæƒ…æ•°æ®\nâ€¢ ç‚¹å‡»ğŸŒ™å‘¨æœŸå½•å…¥ç”Ÿç†å‘¨æœŸæ•°æ®');
                return;
            }
            
            // ç”ŸæˆæŠ¥å‘Š
            const report = generateHealthReport(allData);
            
            // å…ˆæ˜¾ç¤ºæŠ¥å‘Šå†…å®¹
            showWatchReport(report);
            
            // å¤åˆ¶åˆ°å‰ªè´´æ¿
            copyReport(report);
            
            // æ·»åŠ å»¶è¿Ÿåæ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤ºï¼ˆç¡®ä¿æŠ¥å‘Šå·²ç»æ˜¾ç¤ºï¼‰
            setTimeout(() => {
                showWatchReport(report + '\n\n' + 'âœ… æŠ¥å‘Šå·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\næ‚¨å¯ä»¥ç²˜è´´åˆ°ä»»ä½•æ–‡æœ¬ç¼–è¾‘å™¨ä¸­ä¿å­˜æˆ–åˆ†äº«ã€‚');
            }, 100);
        }



        function collectModuleData() {
            const allData = [];
            for (let day = 1; day <= dayCount; day++) {
                const daySection = document.getElementById(`day-${day}`);
                if (!daySection) continue;
                
                const dayData = {
                    day: day,
                    module: currentModule
                };
                
                // æ”¶é›†æ•°å€¼æ•°æ®
                const config = moduleConfigs[currentModule];
                config.fields.forEach(fieldName => {
                    if (knobConfigs[fieldName]) {
                        const directInput = document.getElementById(`direct-${fieldName}-${day}`);
                        if (directInput && directInput.value && !isNaN(parseFloat(directInput.value))) {
                            dayData[fieldName] = parseFloat(directInput.value);
                        } else {
                            const hiddenInput = document.getElementById(`input-${fieldName}-${day}`);
                            dayData[fieldName] = hiddenInput ? parseFloat(hiddenInput.value) || 0 : 0;
                        }
                    } else if (emojiConfigs[fieldName]) {
                        const selectedOption = daySection.querySelector(`input[name="${fieldName}_${day}"]`);
                        dayData[fieldName] = selectedOption ? selectedOption.value : emojiConfigs[fieldName][0].value;
                    }
                });
                
                allData.push(dayData);
            }
            return allData;
        }

        function collectActualEnteredData() {
            // ä¼˜å…ˆä»å…¨å±€å­˜å‚¨æ”¶é›†æ•°æ®ï¼Œç¡®ä¿è·å–åˆ°æ‰€æœ‰å½•å…¥çš„æ•°æ®
            const allData = [];
            
            // éå†æ‰€æœ‰å·²ä¿å­˜çš„æ¨¡å—æ•°æ®
            Object.keys(globalHealthData).forEach(moduleType => {
                const moduleData = globalHealthData[moduleType];
                if (moduleData && Object.keys(moduleData).length > 0) {
                    // éå†æ‰€æœ‰å¤©æ•°çš„æ•°æ®
                    Object.keys(moduleData).forEach(dayKey => {
                        const dayData = moduleData[dayKey];
                        if (dayData && dayData.day && Object.keys(dayData).length > 2) {
                            allData.push({
                                day: dayData.day,
                                module: moduleType,
                                ...dayData
                            });
                        }
                    });
                }
            });
            
            // å¦‚æœå…¨å±€å­˜å‚¨ä¸­æ²¡æœ‰æ•°æ®ï¼Œå°è¯•ä»å½“å‰DOMè·å–ï¼ˆä½œä¸ºå¤‡ç”¨ï¼‰
            if (allData.length === 0) {
                // éå†æ‰€æœ‰æ¨¡å—ç±»å‹ï¼šsleep, activity, cycle
                Object.keys(moduleConfigs).forEach(moduleType => {
                    const config = moduleConfigs[moduleType];
                    const moduleData = { day: 1, module: moduleType };
                    let hasData = false;
                    
                    // æ£€æŸ¥è¯¥æ¨¡å—çš„æ‰€æœ‰å­—æ®µ
                    config.fields.forEach(fieldName => {
                        if (knobConfigs[fieldName]) {
                            // æ•°å€¼å­—æ®µï¼Œå°è¯•æŸ¥æ‰¾è¾“å…¥å…ƒç´ 
                            const selectors = [
                                `#input-${fieldName}-1`,
                                `#direct-${fieldName}-1`,
                                `input[name="${fieldName}_1"]`
                            ];
                            
                            for (let selector of selectors) {
                                const input = document.querySelector(selector);
                                if (input && input.value && !isNaN(parseFloat(input.value))) {
                                    const value = parseFloat(input.value);
                                    // éªŒè¯å€¼æ˜¯å¦åœ¨åˆç†èŒƒå›´å†…
                                    const configRange = knobConfigs[fieldName];
                                    if (value >= configRange.min && value <= configRange.max) {
                                        moduleData[fieldName] = value;
                                        hasData = true;
                                        break;
                                    }
                                }
                            }
                        } else if (emojiConfigs[fieldName]) {
                            // é€‰æ‹©å­—æ®µï¼Œæ£€æŸ¥æ˜¯å¦æœ‰é€‰ä¸­çš„é€‰é¡¹
                            const selectedOption = document.querySelector(`input[name="${fieldName}_1"]`);
                            if (selectedOption && selectedOption.value) {
                                moduleData[fieldName] = selectedOption.value;
                                hasData = true;
                            }
                        }
                    });
                    
                    // å¦‚æœè¯¥æ¨¡å—æœ‰æ•°æ®ï¼Œæ·»åŠ åˆ°ç»“æœä¸­
                    if (hasData) {
                        allData.push(moduleData);
                    }
                });
            }
            
            return allData;
        }
        
        function showWatchReport(content) {
            const reportArea = document.getElementById('watchReportArea');
            const reportContent = document.getElementById('watchReportContent');
            
            if (reportArea && reportContent) {
                reportContent.textContent = content;
                reportArea.style.display = 'block';
                
                // æ»šåŠ¨åˆ°æŠ¥å‘Šæ˜¾ç¤ºåŒºåŸŸ
                reportArea.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }
        
        function hideWatchReport() {
            const reportArea = document.getElementById('watchReportArea');
            if (reportArea) {
                reportArea.style.display = 'none';
            }
        }

        // æµ‹è¯•å‡½æ•°ï¼šéªŒè¯æŠ¥å‘ŠåŠŸèƒ½æ˜¯å¦æ­£å¸¸
        function testReportFunctions() {
            console.log('å¼€å§‹æµ‹è¯•æŠ¥å‘ŠåŠŸèƒ½...');
            
            // æµ‹è¯• 1ï¼šæ£€æŸ¥å¿…è¦å‡½æ•°æ˜¯å¦å­˜åœ¨
            const requiredFunctions = ['generateAndCopyReport', 'generateAndCopyReportFromWatch', 'collectModuleData', 'generateHealthReport', 'copyReport'];
            let testPassed = true;
            
            requiredFunctions.forEach(funcName => {
                if (typeof window[funcName] !== 'function') {
                    console.error(`âŒ å‡½æ•° ${funcName} ä¸å­˜åœ¨`);
                    testPassed = false;
                } else {
                    console.log(`âœ… å‡½æ•° ${funcName} å­˜åœ¨`);
                }
            });
            
            // æµ‹è¯• 2ï¼šæ£€æŸ¥å…³é”®DOMå…ƒç´ 
            const criticalElements = ['watchReportArea', 'reportOutput', 'daysContainer'];
            criticalElements.forEach(elementId => {
                const element = document.getElementById(elementId);
                if (!element) {
                    console.error(`âŒ å…ƒç´  ${elementId} ä¸å­˜åœ¨`);
                    testPassed = false;
                } else {
                    console.log(`âœ… å…ƒç´  ${elementId} å­˜åœ¨`);
                }
            });
            
            if (testPassed) {
                console.log('âœ… æ ¸å¿ƒæŠ¥å‘ŠåŠŸèƒ½æµ‹è¯•é€šè¿‡ï¼');
                alert('âœ… æŠ¥å‘ŠåŠŸèƒ½æµ‹è¯•é€šè¿‡ï¼Œæ‰€æœ‰å¿…è¦ç»„ä»¶éƒ½æ­£å¸¸å·¥ä½œã€‚');
            } else {
                console.error('âŒ æŠ¥å‘ŠåŠŸèƒ½æµ‹è¯•å¤±è´¥ï¼Œå­˜åœ¨é—®é¢˜éœ€è¦ä¿®å¤ã€‚');
                alert('âŒ æŠ¥å‘ŠåŠŸèƒ½æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚');
            }
            
            return testPassed;
        }

        // é‡ç½®æ‰€æœ‰æ•°æ®ï¼ˆç”¨äºæµ‹è¯•ï¼‰
        function resetAllData() {
            globalHealthData = {};
            initializeForm();
            hideWatchReport();
            console.log('âœ… å·²é‡ç½®æ‰€æœ‰æ•°æ®');
        }

        function generateHealthReport(allData) {
            // åªå¯¹å®é™…å­˜åœ¨çš„æ•°æ®è®¡ç®—å¹³å‡å€¼
            const calculateAverage = (values) => {
                const validValues = values.filter(val => val !== undefined && val !== null && !isNaN(val));
                return validValues.length > 0 ? validValues.reduce((sum, val) => sum + val, 0) / validValues.length : 0;
            };
            
            // æå–å„ç±»æ•°æ®
            const sleepData = allData.filter(d => d.deepSleep !== undefined || d.restingHR !== undefined || d.bloodOxygen !== undefined);
            const activityData = allData.filter(d => d.stressLevel !== undefined || d.dailySteps !== undefined || d.moodStatus !== undefined);
            const cycleData = allData.filter(d => d.cycleStatus !== undefined);
            
            const deepSleepAvg = calculateAverage(sleepData.map(d => d.deepSleep));
            const sleepScoreAvg = calculateAverage(sleepData.map(d => d.sleepScore));
            const stressLevelAvg = calculateAverage(activityData.map(d => d.stressLevel));
            const dailyStepsAvg = calculateAverage(activityData.map(d => d.dailySteps));
            const restingHRAvg = calculateAverage(sleepData.map(d => d.restingHR));
            const bloodOxygenAvg = calculateAverage(sleepData.map(d => d.bloodOxygen));
            
            // ç”Ÿæˆå¥åº·çŠ¶æ€æè¿°
            const getSleepStatus = () => {
                if (sleepData.length === 0) return 'æš‚æ— æ•°æ®';
                if (deepSleepAvg >= 1.5) return 'è‰¯å¥½';
                if (deepSleepAvg >= 1.0) return 'ä¸€èˆ¬';
                return 'è¾ƒå·®';
            };
            const getStressStatus = () => {
                if (activityData.length === 0) return 'æš‚æ— æ•°æ®';
                if (stressLevelAvg < 30) return 'è½»æ¾';
                if (stressLevelAvg < 70) return 'ä¸­ç­‰';
                return 'åé«˜';
            };
            const getActivityStatus = () => {
                if (activityData.length === 0) return 'æš‚æ— æ•°æ®';
                if (dailyStepsAvg >= 8000) return 'è¾¾æ ‡';
                if (dailyStepsAvg >= 5000) return 'ä¸€èˆ¬';
                return 'ä¸è¶³';
            };
            
            // ç”Ÿæˆå„å¤©æ•°æ®è¯¦æƒ…
            const generateDailyDetails = () => {
                return allData.map(data => {
                    let details = `ç¬¬${data.day}å¤©ï¼ˆ${getModuleName(data.module)}ï¼‰ï¼š\n`;
                    
                    if (data.deepSleep !== undefined) details += `- ç¡çœ æ—¶é•¿ï¼š${data.deepSleep.toFixed(1)}å°æ—¶\n`;
                    if (data.sleepScore !== undefined) details += `- ç¡çœ å¾—åˆ†ï¼š${data.sleepScore.toFixed(0)}åˆ†\n`;
                    if (data.stressLevel !== undefined) details += `- å‹åŠ›å€¼ï¼š${data.stressLevel.toFixed(0)}\n`;
                    if (data.dailySteps !== undefined) details += `- æ­¥æ•°ï¼š${data.dailySteps.toFixed(0)}æ­¥\n`;
                    if (data.restingHR !== undefined) details += `- é™æ¯å¿ƒç‡ï¼š${data.restingHR.toFixed(0)}æ¬¡/åˆ†\n`;
                    if (data.bloodOxygen !== undefined) details += `- è¡€æ°§ï¼š${data.bloodOxygen.toFixed(0)}%\n`;
                    if (data.cycleStatus !== undefined) details += `- å‘¨æœŸï¼š${data.cycleStatus}\n`;
                    if (data.moodStatus !== undefined) details += `- çŠ¶æ€ï¼š${data.moodStatus}\n`;
                    
                    return details.trim();
                }).join('\n\n');
            };
            
            const getModuleName = (module) => {
                const names = { sleep: 'ç¡çœ æ•°æ®', activity: 'è¿åŠ¨æ•°æ®', cycle: 'å‘¨æœŸæ•°æ®' };
                return names[module] || 'å¥åº·æ•°æ®';
            };
            
            // ç”Ÿæˆæ±‡æ€»æŠ¥å‘Š
            let report = `åä¸ºå¥åº·æŠ¥å‘Šï¼ˆ${allData.length}æ¡æ•°æ®æ±‡æ€»ï¼‰\n`;
            report += `æ—¶é—´ï¼š${new Date().toLocaleDateString('zh-CN')}\n\n`;
            
            report += `å¥åº·çŠ¶æ€ï¼š\n`;
            report += `ç¡çœ è´¨é‡ï¼š${getSleepStatus()}${sleepData.length > 0 ? ` (${deepSleepAvg.toFixed(1)}å°æ—¶å¹³å‡)` : ''}\n`;
            report += `å‹åŠ›æ°´å¹³ï¼š${getStressStatus()}${activityData.length > 0 ? ` (${stressLevelAvg.toFixed(0)}å¹³å‡)` : ''}\n`;
            report += `è¿åŠ¨è¾¾æ ‡ï¼š${getActivityStatus()}${activityData.length > 0 ? ` (${dailyStepsAvg.toFixed(0)}æ­¥å¹³å‡)` : ''}\n`;
            report += `é™æ¯å¿ƒç‡ï¼š${restingHRAvg > 0 ? `${restingHRAvg.toFixed(0)}æ¬¡/åˆ†` : 'æš‚æ— æ•°æ®'}\n`;
            report += `è¡€æ°§é¥±å’Œåº¦ï¼š${bloodOxygenAvg > 0 ? `${bloodOxygenAvg.toFixed(0)}%` : 'æš‚æ— æ•°æ®'}\n\n`;
            
            report += `è¯¦ç»†æ•°æ®ï¼š\n${generateDailyDetails()}\n\n`;
            
            report += `å»ºè®®ï¼š\n`;
            report += `â€¢ ä¿æŒè§„å¾‹ä½œæ¯ï¼Œç¡®ä¿å……è¶³ç¡çœ \n`;
            report += `â€¢ é€‚åº¦è¿åŠ¨ï¼Œç¼“è§£å·¥ä½œå‹åŠ›  \n`;
            report += `â€¢ å…³æ³¨èº«ä½“ä¿¡å·ï¼ŒåŠæ—¶è°ƒæ•´çŠ¶æ€`;
            
            return report;
        }

        function copyReport(reportText) {
            if (!reportText) {
                reportText = document.getElementById('reportOutput').textContent;
            }
            
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(reportText).then(() => {
                    showCopySuccess();
                }).catch(err => {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                    fallbackCopyTextToClipboard(reportText);
                });
            } else {
                fallbackCopyTextToClipboard(reportText);
            }
        }

        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showCopySuccess();
                } else {
                    alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
                }
            } catch (err) {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
            }
            
            document.body.removeChild(textArea);
        }

        function showCopySuccess() {
            // æŸ¥æ‰¾æŠ¥å‘ŠæŒ‰é’®ï¼ˆæ‰‹è¡¨ç•Œé¢æˆ–æ•°æ®å½•å…¥ç•Œé¢ï¼‰
            const moduleReportBtn = document.querySelector('.module-report');
            const generateBtn = document.querySelector('.generate-btn');
            
            let targetBtn = generateBtn;
            let originalText = 'ç”Ÿæˆå¹¶å¤åˆ¶æŠ¥å‘Š';
            
            // å¦‚æœåœ¨æ‰‹è¡¨ç•Œé¢ï¼Œä½¿ç”¨æ¨¡å—æŒ‰é’®
            if (document.getElementById('watchMain').style.display === 'block' && moduleReportBtn) {
                targetBtn = moduleReportBtn;
                originalText = 'ğŸ“Š\næŠ¥å‘Š';
            }
            
            if (targetBtn) {
                const successText = targetBtn === moduleReportBtn ? 'âœ“ å·²å¤åˆ¶' : 'å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ âœ“';
                
                if (targetBtn === moduleReportBtn) {
                    // æ‰‹è¡¨ç•Œé¢æŒ‰é’®ç‰¹æ®Šå¤„ç†
                    const originalHTML = targetBtn.innerHTML;
                    targetBtn.innerHTML = `<div class="module-icon">âœ“</div><div>å·²å¤åˆ¶</div>`;
                    targetBtn.style.background = '#27ae60';
                    
                    setTimeout(() => {
                        targetBtn.innerHTML = originalHTML;
                        targetBtn.style.background = '#e74c3c';
                    }, 2000);
                } else {
                    // æ•°æ®å½•å…¥ç•Œé¢æŒ‰é’®
                    targetBtn.textContent = successText;
                    targetBtn.classList.add('success');
                    
                    setTimeout(() => {
                        targetBtn.textContent = originalText;
                        targetBtn.classList.remove('success');
                    }, 2000);
                }
            }
            
            // åŒæ—¶æ˜¾ç¤ºå¤åˆ¶æˆåŠŸçš„æç¤º
            showWatchReport('âœ… æŠ¥å‘Šå·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\n\næ‚¨å¯ä»¥ç²˜è´´åˆ°ä»»ä½•æ–‡æœ¬ç¼–è¾‘å™¨ä¸­ä¿å­˜æˆ–åˆ†äº«ã€‚');
        }

        // æ—¶é—´æ›´æ–°åŠŸèƒ½
        function updateWatchTime() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const timeString = `${hours}:${minutes}`;
            
            const dateString = `${now.getMonth() + 1}æœˆ${now.getDate()}æ—¥ ${['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'][now.getDay()]}`;
            
            const moonPhase = getMoonPhase();
            const moonString = moonPhase.emoji + ' ' + moonPhase.name;
            
            // æ›´æ–°æ•°æ®å‘¨æœŸä¸ºåªæ˜¾ç¤ºå½“å¤©
            const periodString = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;
            const dataPeriodElement = document.getElementById('dataPeriod');
            if (dataPeriodElement) {
                dataPeriodElement.textContent = `æ•°æ®å‘¨æœŸï¼š${periodString}`;
            }
            
            document.getElementById('watchTime').textContent = timeString;
            document.getElementById('watchDate').textContent = dateString;
            document.getElementById('watchMoon').textContent = moonString;
        }

        // è·å–æœˆç›¸
        function getMoonPhase() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth() + 1;
            const day = now.getDate();
            
            // ç®€å•çš„æœˆç›¸è®¡ç®—ï¼ˆåŸºäº2025å¹´11æœˆ27æ—¥ä¸ºæ–°æœˆï¼‰
            const newMoonDate = new Date(2025, 10, 27); // 2025å¹´11æœˆ27æ—¥æ–°æœˆ
            const daysSinceNewMoon = Math.floor((now - newMoonDate) / (1000 * 60 * 60 * 24));
            const lunarCycle = 29.53; // æœˆçƒå‘¨æœŸ
            const currentPhase = (daysSinceNewMoon % lunarCycle) / lunarCycle;
            
            let phase, emoji;
            
            if (currentPhase < 0.0625 || currentPhase >= 0.9375) {
                phase = 'æ–°æœˆ';
                emoji = 'ğŸŒ‘';
            } else if (currentPhase < 0.1875) {
                phase = 'å³¨çœ‰æœˆ';
                emoji = 'ğŸŒ’';
            } else if (currentPhase < 0.3125) {
                phase = 'ä¸Šå¼¦æœˆ';
                emoji = 'ğŸŒ“';
            } else if (currentPhase < 0.4375) {
                phase = 'ç›ˆå‡¸æœˆ';
                emoji = 'ğŸŒ”';
            } else if (currentPhase < 0.5625) {
                phase = 'æ»¡æœˆ';
                emoji = 'ğŸŒ•';
            } else if (currentPhase < 0.6875) {
                phase = 'äºå‡¸æœˆ';
                emoji = 'ğŸŒ–';
            } else if (currentPhase < 0.8125) {
                phase = 'ä¸‹å¼¦æœˆ';
                emoji = 'ğŸŒ—';
            } else {
                phase = 'æ®‹æœˆ';
                emoji = 'ğŸŒ˜';
            }
            
            return { name: phase, emoji: emoji };
        }

        // ç”Ÿæˆè¡¨ç›˜åˆ»åº¦
        function generateWatchScale() {
            const scaleContainer = document.getElementById('watchScale');
            if (!scaleContainer) return;
            
            scaleContainer.innerHTML = '';
            
            // ç”Ÿæˆ60ä¸ªåˆ»åº¦ï¼ˆæ¯åˆ†é’Ÿä¸€ä¸ªï¼‰
            for (let i = 0; i < 60; i++) {
                const mark = document.createElement('div');
                mark.className = 'scale-mark' + (i % 5 === 0 ? ' major' : '');
                mark.style.transform = `rotate(${i * 6}deg)`;
                scaleContainer.appendChild(mark);
            }
        }

        // æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' || event.key === 'Backspace') {
                showWatchMain();
            }
        });

        // æ£€æŸ¥å¹¶è¿”å›ä¸»ç•Œé¢çš„å‡½æ•°
        function checkAndReturnToMain() {
            // æ£€æŸ¥å…¨å±€å¥åº·æ•°æ®æ˜¯å¦æœ‰ä»»ä½•å½•å…¥çš„æ•°æ®
            let hasData = false;
            
            // æ£€æŸ¥æ‰€æœ‰æ¨¡å—ç±»å‹çš„æ•°æ®
            Object.keys(globalHealthData).forEach(moduleType => {
                const moduleData = globalHealthData[moduleType];
                if (moduleData && typeof moduleData === 'object') {
                    // æ£€æŸ¥è¯¥æ¨¡å—çš„æ¯ä¸€å¤©æ˜¯å¦æœ‰æ•°æ®
                    Object.keys(moduleData).forEach(day => {
                        const dayData = moduleData[day];
                        if (dayData && typeof dayData === 'object') {
                            // æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•å­—æ®µæœ‰éç©ºå€¼
                            Object.values(dayData).forEach(value => {
                                if (value !== null && value !== undefined && value !== '' && value !== 0) {
                                    hasData = true;
                                }
                            });
                        }
                    });
                }
            });
            
            if (hasData) {
                // æœ‰æ•°æ®ï¼Œç›´æ¥è¿”å›ä¸»ç•Œé¢
                showWatchMain();
            } else {
                // æ²¡æœ‰æ•°æ®ï¼Œè¯¢é—®ç¡®è®¤
                const confirmReturn = confirm('å½“å‰æ²¡æœ‰ä»»ä½•æ•°æ®å½•å…¥ï¼Œç¡®å®šè¦è¿”å›ä¸»ç•Œé¢å—ï¼Ÿ\n\næç¤ºï¼šæ‚¨å¯ä»¥å…ˆå½•å…¥ä¸€äº›å¥åº·æ•°æ®ï¼Œæˆ–è€…ç‚¹å‡»"ç¡®å®š"ç›´æ¥è¿”å›ã€‚');
                if (confirmReturn) {
                    showWatchMain();
                }
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåˆå§‹åŒ–
        window.addEventListener('load', function() {
            console.log('æ‰‹è¡¨å¼å¥åº·æ•°æ®æŠ¥å‘Šç”Ÿæˆå™¨å·²åŠ è½½å®Œæˆ');
            
            // ç”Ÿæˆè¡¨ç›˜åˆ»åº¦
            setTimeout(generateWatchScale, 100);
            
            // æ˜¾ç¤ºæ‰‹è¡¨ä¸»ç•Œé¢
            setTimeout(() => {
                showWatchMain();
            }, 200);
            
            // ç«‹å³æ›´æ–°æ—¶é—´å¹¶è®¾ç½®æ¯åˆ†é’Ÿæ›´æ–°
            updateWatchTime();
            setInterval(updateWatchTime, 60000);
        });
    </script>
</body>
</html>